<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: 'Google Sans', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 500;
    }
    
    .header p {
      margin: 8px 0 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      flex: 1;
      padding: 12px 8px;
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #667eea;
      background: #f8f9fa;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* â”€â”€ Controls â”€â”€ */
    .controls {
      padding: 16px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 8px;
      transition: background 0.2s;
    }
    
    .btn:hover { background: #5568d3; }
    
    .btn-secondary {
      background: white;
      color: #667eea;
      border: 1px solid #667eea;
    }
    
    .btn-secondary:hover { background: #f8f9fa; }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* â”€â”€ Stats bar â”€â”€ */
    .stats {
      padding: 12px 16px;
      background: white;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-around;
      font-size: 13px;
    }
    
    .stat { text-align: center; }
    
    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: #667eea;
    }
    
    .stat-label {
      color: #666;
      margin-top: 4px;
    }

    /* â”€â”€ Spinner â”€â”€ */
    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* â”€â”€ Issue cards (language tab) â”€â”€ */
    .issues-container {
      padding: 16px;
    }
    
    .issue-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid #ff9800;
      cursor: pointer;
      transition: all 0.2s;
      scroll-margin-top: 12px;
    }
    
    .issue-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .issue-card.active {
      border-left-color: #667eea;
      box-shadow: 0 0 0 2px #667eea, 0 4px 12px rgba(102,126,234,0.3);
      transform: translateY(-2px);
    }
    
    .issue-card.dismissed { display: none; }
    
    .issue-category {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .issue-text {
      background: #fff3cd;
      padding: 8px 10px;
      border-radius: 4px;
      margin-bottom: 8px;
      font-family: monospace;
      font-size: 12px;
      word-break: break-word;
    }
    
    .issue-message {
      color: #333;
      font-size: 13px;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .issue-suggestion {
      background: #e8f5e9;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #2e7d32;
      margin-bottom: 12px;
    }
    
    .learn-more {
      color: #1976d2;
      text-decoration: none;
      font-weight: 600;
      font-size: 11px;
      display: inline-block;
      margin-top: 4px;
    }
    .learn-more:hover { text-decoration: underline; }
    
    .issue-actions { display: flex; gap: 8px; }
    
    .issue-btn {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-accept { background: #4caf50; color: white; }
    .btn-accept:hover { background: #45a049; }
    
    .btn-dismiss { background: #ffebee; color: #c62828; }
    .btn-dismiss:hover { background: #ffcdd2; }
    
    .no-replacement {
      font-size: 11px;
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 4px;
    }

    /* â”€â”€ Section cards (structure tab) â”€â”€ */
    .sections-container {
      padding: 16px;
    }

    .section-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }

    .section-card.severity-high {
      border-left: 4px solid #e53935;
    }

    .section-card.severity-medium {
      border-left: 4px solid #ff9800;
    }

    .section-card.severity-low {
      border-left: 4px solid #2196f3;
    }

    .section-card.severity-ok {
      border-left: 4px solid #4caf50;
      opacity: 0.7;
    }

    .section-type-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      margin-right: 6px;
    }

    .badge-missing { background: #ffebee; color: #c62828; }
    .badge-content { background: #fff3e0; color: #e65100; }
    .badge-order   { background: #e3f2fd; color: #1565c0; }
    .badge-ok      { background: #e8f5e9; color: #2e7d32; }

    .section-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .section-message {
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }

    .section-suggestion {
      background: #e8f5e9;
      padding: 8px 10px;
      border-radius: 4px;
      font-size: 12px;
      color: #2e7d32;
    }

    /* checklist at the top of sections tab */
    .section-checklist {
      padding: 12px 16px 0 16px;
    }

    .checklist-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid #f0f0f0;
    }

    .checklist-item:last-child { border-bottom: none; }

    .check-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .check-label { color: #333; }
    .check-label.missing { color: #c62828; }
    .check-label.warning { color: #e65100; }
    .check-label.ok      { color: #2e7d32; }

    /* â”€â”€ Empty / no-issues â”€â”€ */
    .no-issues {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .no-issues-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .cursor-hint {
      margin: 0 16px;
      padding: 8px 12px;
      background: #e8f0fe;
      border-radius: 6px;
      font-size: 12px;
      color: #3c4043;
      display: none;
      align-items: center;
      gap: 8px;
    }
    
    .footer {
      padding: 16px;
      text-align: center;
      font-size: 11px;
      color: #999;
      background: white;
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ“ Syllabus Style Checker</h1>
    <p>Improve with inclusive language</p>
  </div>

  <!-- Tab bar -->
  <div class="tabs">
    <div class="tab active" id="tab-language" onclick="switchTab('language')">âœï¸ Language</div>
    <div class="tab"        id="tab-structure" onclick="switchTab('structure')">ğŸ“‹ Structure</div>
  </div>

  <!-- â•â• LANGUAGE TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel active" id="panel-language">
    <div class="controls">
      <button class="btn" onclick="runCheck()">ğŸ” Check Language</button>
      <button class="btn btn-secondary" onclick="clearAll()">Clear All Highlights</button>
    </div>

    <div class="stats" id="lang-stats" style="display:none;">
      <div class="stat">
        <div class="stat-value" id="issueCount">0</div>
        <div class="stat-label">Suggestions</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="categoryCount">0</div>
        <div class="stat-label">Categories</div>
      </div>
    </div>

    <div class="cursor-hint" id="cursorHint">
      ğŸ‘† Click on any highlighted word in your document to jump to its suggestion
    </div>

    <div id="lang-content">
      <div class="no-issues">
        <div class="no-issues-icon">ğŸ‘‹</div>
        <p><strong>Welcome!</strong></p>
        <p>Click "Check Language" to scan your syllabus for tone, accessibility, and student-centered language suggestions.</p>
      </div>
    </div>
  </div>

  <!-- â•â• STRUCTURE TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="tab-panel" id="panel-structure">
    <div class="controls">
      <button class="btn" onclick="runStructureCheck()">ğŸ“‹ Check Structure</button>
    </div>

    <div id="structure-content">
      <div class="no-issues">
        <div class="no-issues-icon">ğŸ—‚ï¸</div>
        <p><strong>Section Checker</strong></p>
        <p>Click "Check Structure" to see whether your syllabus includes all recommended sections in the right order.</p>
      </div>
    </div>
  </div>

  <div class="footer">
    Syllabus Style Checker â€¢ Click a language card to jump to it in the document
  </div>

  <script>
    let currentIssues = [];
    let pollingInterval = null;
    let lastMatchedText = null;

    // â”€â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
      document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById('tab-' + tab).classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');

      // Pause cursor polling while the structure tab is visible
      if (tab === 'structure') {
        stopPolling();
      } else if (currentIssues.length > 0) {
        startPolling();
      }
    }

    // â”€â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function startPolling() {
      stopPolling();
      pollingInterval = setInterval(pollCursor, 800);
    }

    function stopPolling() {
      if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
    }

    function pollCursor() {
      if (currentIssues.length === 0) return;
      google.script.run
        .withSuccessHandler(onCursorResult)
        .withFailureHandler(function() {})
        .getCursorMatchedText();
    }

    function onCursorResult(matchedText) {
      if (matchedText === lastMatchedText) return;
      lastMatchedText = matchedText;

      document.querySelectorAll('.issue-card.active').forEach(function(c) { c.classList.remove('active'); });
      if (!matchedText) return;

      for (let i = 0; i < currentIssues.length; i++) {
        if (currentIssues[i].matchedText === matchedText) {
          const card = document.getElementById('issue-' + i);
          if (card && !card.classList.contains('dismissed')) {
            card.classList.add('active');
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            break;
          }
        }
      }
    }

    // â”€â”€â”€ Language check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function runCheck() {
      stopPolling();
      document.getElementById('lang-content').innerHTML = loadingHtml('Analyzing language...');
      document.getElementById('lang-stats').style.display = 'none';
      document.getElementById('cursorHint').style.display = 'none';

      google.script.run
        .withSuccessHandler(displayIssues)
        .withFailureHandler(showLangError)
        .checkDocument();
    }

    function displayIssues(issues) {
      currentIssues = issues;
      lastMatchedText = null;

      const content = document.getElementById('lang-content');
      const stats   = document.getElementById('lang-stats');

      if (issues.length === 0) {
        content.innerHTML = emptyHtml('âœ…', 'Great job!', 'No language suggestions found. Your syllabus looks good!');
        stats.style.display = 'none';
        document.getElementById('cursorHint').style.display = 'none';
        return;
      }

      const categories = new Set(issues.map(function(i) { return i.category; }));
      document.getElementById('issueCount').textContent  = issues.length;
      document.getElementById('categoryCount').textContent = categories.size;
      stats.style.display = 'flex';
      document.getElementById('cursorHint').style.display = 'flex';

      let html = '<div class="issues-container">';
      issues.forEach(function(issue, index) {
        const hasReplacement = issue.replacement && issue.replacement.trim().length > 0;
        const hasLearnMore   = issue.learnMoreUrl && issue.learnMoreUrl.trim().length > 0;

        html += `
          <div class="issue-card" id="issue-${index}" onclick="navigateToIssue(${index})">
            <span class="issue-category">${escapeHtml(issue.category)}</span>
            <div class="issue-text">"${escapeHtml(issue.matchedText)}"</div>
            <div class="issue-message">${escapeHtml(issue.message)}</div>
            <div class="issue-suggestion">
              ğŸ’¡ ${escapeHtml(issue.suggestion)}
              ${hasLearnMore ? `<br><a href="${escapeHtml(issue.learnMoreUrl)}" target="_blank" class="learn-more" onclick="event.stopPropagation()">Learn more â†’</a>` : ''}
            </div>
            <div class="issue-actions" onclick="event.stopPropagation()">
              ${hasReplacement
                ? `<button class="issue-btn btn-accept" onclick="acceptSuggestion(${index})">âœ“ Accept: "${escapeHtml(issue.replacement)}"</button>`
                : `<div class="no-replacement">No automatic replacement available</div>`}
              <button class="issue-btn btn-dismiss" onclick="dismissIssue(${index})">âœ— Dismiss</button>
            </div>
          </div>`;
      });
      html += '</div>';
      content.innerHTML = html;
      startPolling();
    }

    function navigateToIssue(index) {
      google.script.run
        .withSuccessHandler(function() {})
        .withFailureHandler(showLangError)
        .navigateToIssue(currentIssues[index].matchedText);
    }

    function acceptSuggestion(index) {
      const issue = currentIssues[index];
      if (!issue.replacement) { alert('No automatic replacement available.'); return; }
      google.script.run
        .withSuccessHandler(function(ok) { if (ok) { dismissCard(index); } })
        .withFailureHandler(showLangError)
        .acceptSuggestion(issue.matchedText, issue.replacement);
    }

    function dismissIssue(index) {
      google.script.run
        .withSuccessHandler(function(ok) { if (ok) { dismissCard(index); } })
        .withFailureHandler(showLangError)
        .dismissIssue(currentIssues[index].matchedText);
    }

    function dismissCard(index) {
      const card = document.getElementById('issue-' + index);
      if (card) card.classList.add('dismissed');
      const remaining = document.querySelectorAll('.issue-card:not(.dismissed)').length;
      document.getElementById('issueCount').textContent = remaining;
      if (remaining === 0) {
        stopPolling();
        document.getElementById('lang-content').innerHTML = emptyHtml('ğŸ‰', 'All done!', "You've addressed all the suggestions!");
        document.getElementById('lang-stats').style.display = 'none';
        document.getElementById('cursorHint').style.display = 'none';
      }
    }

    function clearAll() {
      stopPolling();
      currentIssues = [];
      lastMatchedText = null;
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('lang-content').innerHTML = emptyHtml('âœ¨', 'Highlights cleared!', 'All highlighting has been removed from your document.');
          document.getElementById('lang-stats').style.display = 'none';
          document.getElementById('cursorHint').style.display = 'none';
        })
        .withFailureHandler(showLangError)
        .clearHighlights();
    }

    function showLangError(error) {
      document.getElementById('lang-content').innerHTML = emptyHtml('âš ï¸', 'Error', escapeHtml(error.message));
    }

    // â”€â”€â”€ Structure check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function runStructureCheck() {
      document.getElementById('structure-content').innerHTML = loadingHtml('Checking structure...');

      google.script.run
        .withSuccessHandler(displayStructure)
        .withFailureHandler(showStructureError)
        .checkSections();
    }

    function displayStructure(suggestions) {
      const content = document.getElementById('structure-content');

      // Build a quick-glance checklist at the top
      // We know all expected section ids from the suggestions; reconstruct state per section
      const sectionState = {}; // id â†’ 'ok' | 'missing' | 'content' | 'order'

      // Start everyone as ok
      const allIds = ['welcome','description','philosophy','expectations','attendance','latework','accommodations','honesty'];
      const allLabels = {
        welcome: 'Welcome',
        description: 'Course Description',
        philosophy: 'Teaching Philosophy',
        expectations: 'What to Expect',
        attendance: 'Attendance',
        latework: 'Late Work',
        accommodations: 'Accommodations',
        honesty: 'Academic Honesty'
      };
      allIds.forEach(function(id) { sectionState[id] = 'ok'; });

      suggestions.forEach(function(s) {
        // Worst state wins: missing > content > order
        const rank = { missing: 3, content: 2, order: 1, ok: 0 };
        if ((rank[s.type] || 0) > (rank[sectionState[s.sectionId]] || 0)) {
          sectionState[s.sectionId] = s.type;
        }
      });

      const checkIcon  = { ok: 'âœ…', missing: 'âŒ', content: 'âš ï¸', order: 'ğŸ”€' };
      const checkClass = { ok: 'ok', missing: 'missing', content: 'warning', order: 'warning' };

      let checklistHtml = '<div class="section-checklist">';
      allIds.forEach(function(id) {
        const state = sectionState[id];
        checklistHtml += `
          <div class="checklist-item">
            <span class="check-icon">${checkIcon[state]}</span>
            <span class="check-label ${checkClass[state]}">${allLabels[id]}</span>
          </div>`;
      });
      checklistHtml += '</div>';

      if (suggestions.length === 0) {
        content.innerHTML = checklistHtml + emptyHtml('ğŸ‰', 'All sections present!', 'Your syllabus includes all recommended sections in the right order.');
        return;
      }

      let cardsHtml = '<div class="sections-container">';
      suggestions.forEach(function(s) {
        const badgeClass = 'badge-' + s.type;
        const badgeLabel = { missing: 'Missing', content: 'Needs Content', order: 'Order Issue' }[s.type] || s.type;

        cardsHtml += `
          <div class="section-card severity-${s.severity}">
            <div>
              <span class="section-type-badge ${badgeClass}">${badgeLabel}</span>
              <span class="section-label">${escapeHtml(s.sectionLabel)}</span>
            </div>
            <div class="section-message">${escapeHtml(s.message)}</div>
            <div class="section-suggestion">ğŸ’¡ ${escapeHtml(s.suggestion)}</div>
          </div>`;
      });
      cardsHtml += '</div>';

      content.innerHTML = checklistHtml + cardsHtml;
    }

    function showStructureError(error) {
      document.getElementById('structure-content').innerHTML = emptyHtml('âš ï¸', 'Error', escapeHtml(error.message));
    }

    // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function loadingHtml(msg) {
      return `<div class="loading"><div class="spinner"></div><p>${msg}</p></div>`;
    }

    function emptyHtml(icon, title, body) {
      return `<div class="no-issues"><div class="no-issues-icon">${icon}</div><p><strong>${title}</strong></p><p>${body}</p></div>`;
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
